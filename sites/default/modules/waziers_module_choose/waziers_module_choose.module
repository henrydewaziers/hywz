<?php
drupal_add_js(
  drupal_get_path("module", "waziers_module_choose")."/waziers_module_choose.js"
);

function waziers_module_choose_menu()
{
    $items = [];

    $items['node/%/choose'] = [
      'page callback'    => 'waziers_module_choose_example',
      'page arguments'   => [1],
      'access arguments' => ['access content'],
      'type'             => MENU_CALLBACK,
    ];

    return $items;
}

function waziers_module_choose_example($nid)
{

    if (empty($_POST["waziersChoice"])) {
        die();
    }
    global $user;
    $choice = _waziers_module_getChoice($nid, $user->uid);

    $result = ['valid' => true];

    if (null === $choice) {
        $result['sql']          = _waziers_module_choose_insert(
          $nid,
          $user->uid,
          'take' == $_POST["waziersChoice"]
        );
        $result['sql_function'] = 'insert';
    } else {
        $result['sql']          = _waziers_module_choose_update(
          $choice,
          'take' == $_POST["waziersChoice"]
        );
        $result['sql_function'] = 'insert';
    }


    drupal_json_output($result);
    exit();
}


function _waziers_module_choose_update($choice, $choiceValue)
{
    $query = db_update('waziers_choice');
    $query->fields(['choice' => intval($choiceValue)]);
    $query->condition('nid', $choice->nid);
    $query->condition('uid', $choice->uid);

    return $query->execute();
}

function _waziers_module_choose_button($nid, $waziers_choice)
{
    $output = '';
    if ($waziers_choice) {
        $output .= '<div>';
        $output .= '<button class="button button-leave" data-nid="'.$nid.'">';
        $output .= 'Rendre';
        $output .= '</button>';
        $output .= '</div>';
    } else {
        $output .= '<div>';
        $output .= '<button class="button button-choose" data-nid="'.$nid.'">';
        $output .= 'Choisir';
        $output .= '</button>';
        $output .= '</div>';
    }
    return $output;
}

function _waziers_module_choose_insert($nid, $uid, $choiceValue)
{
    $query = db_insert('waziers_choice');
    $query->fields(
      [
        'nid'    => $nid,
        'uid'    => $uid,
        'choice' => $choiceValue,
      ]
    );

    return $query->execute();
}
